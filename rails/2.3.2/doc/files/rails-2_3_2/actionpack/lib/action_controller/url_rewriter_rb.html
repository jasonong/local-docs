  <div id="fileHeader">
    <h1>url_rewriter.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>rails-2.3.2/actionpack/lib/action_controller/url_rewriter.rb</td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Mar 15 23:31:32 -0500 2009</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>module ActionController
  # In &lt;b&gt;routes.rb&lt;/b&gt; one defines URL-to-controller mappings, but the reverse
  # is also possible: an URL can be generated from one of your routing definitions.
  # URL generation functionality is centralized in this module.
  #
  # See ActionController::Routing and ActionController::Resources for general
  # information about routing and routes.rb.
  #
  # &lt;b&gt;Tip:&lt;/b&gt; If you need to generate URLs from your models or some other place,
  # then ActionController::UrlWriter is what you're looking for. Read on for
  # an introduction.
  #
  # == URL generation from parameters
  #
  # As you may know, some functions - such as ActionController::Base#url_for
  # and ActionView::Helpers::UrlHelper#link_to, can generate URLs given a set
  # of parameters. For example, you've probably had the chance to write code
  # like this in one of your views:
  #
  #   &lt;%= link_to('Click here', :controller =&gt; 'users',
  #           :action =&gt; 'new', :message =&gt; 'Welcome!') %&gt;
  #
  #   #=&gt; Generates a link to: /users/new?message=Welcome%21
  #
  # link_to, and all other functions that require URL generation functionality,
  # actually use ActionController::UrlWriter under the hood. And in particular,
  # they use the ActionController::UrlWriter#url_for method. One can generate
  # the same path as the above example by using the following code:
  #
  #   include UrlWriter
  #   url_for(:controller =&gt; 'users',
  #           :action =&gt; 'new',
  #           :message =&gt; 'Welcome!',
  #           :only_path =&gt; true)
  #   # =&gt; &quot;/users/new?message=Welcome%21&quot;
  #
  # Notice the &lt;tt&gt;:only_path =&gt; true&lt;/tt&gt; part. This is because UrlWriter has no
  # information about the website hostname that your Rails app is serving. So if you
  # want to include the hostname as well, then you must also pass the &lt;tt&gt;:host&lt;/tt&gt;
  # argument:
  #
  #   include UrlWriter
  #   url_for(:controller =&gt; 'users',
  #           :action =&gt; 'new',
  #           :message =&gt; 'Welcome!',
  #           :host =&gt; 'www.example.com')        # Changed this.
  #   # =&gt; &quot;http://www.example.com/users/new?message=Welcome%21&quot;
  #
  # By default, all controllers and views have access to a special version of url_for,
  # that already knows what the current hostname is. So if you use url_for in your
  # controllers or your views, then you don't need to explicitly pass the &lt;tt&gt;:host&lt;/tt&gt;
  # argument.
  #
  # For convenience reasons, mailers provide a shortcut for ActionController::UrlWriter#url_for.
  # So within mailers, you only have to type 'url_for' instead of 'ActionController::UrlWriter#url_for'
  # in full. However, mailers don't have hostname information, and what's why you'll still
  # have to specify the &lt;tt&gt;:host&lt;/tt&gt; argument when generating URLs in mailers.
  #
  #
  # == URL generation for named routes
  #
  # UrlWriter also allows one to access methods that have been auto-generated from
  # named routes. For example, suppose that you have a 'users' resource in your
  # &lt;b&gt;routes.rb&lt;/b&gt;:
  #
  #   map.resources :users
  #
  # This generates, among other things, the method &lt;tt&gt;users_path&lt;/tt&gt;. By default,
  # this method is accessible from your controllers, views and mailers. If you need
  # to access this auto-generated method from other places (such as a model), then
  # you can do that in two ways.
  #
  # The first way is to include ActionController::UrlWriter in your class:
  #
  #   class User &lt; ActiveRecord::Base
  #     include ActionController::UrlWriter         # !!!
  #
  #     def name=(value)
  #       write_attribute('name', value)
  #       write_attribute('base_uri', users_path)   # !!!
  #     end
  #   end
  #
  # The second way is to access them through ActionController::UrlWriter.
  # The autogenerated named routes methods are available as class methods:
  #
  #   class User &lt; ActiveRecord::Base
  #     def name=(value)
  #       write_attribute('name', value)
  #       path = ActionController::UrlWriter.users_path   # !!!
  #       write_attribute('base_uri', path)               # !!!
  #     end
  #   end
  module UrlWriter
    def self.included(base) #:nodoc:
      ActionController::Routing::Routes.install_helpers(base)
      base.mattr_accessor :default_url_options

      # The default options for urls written by this writer. Typically a &lt;tt&gt;:host&lt;/tt&gt; pair is provided.
      base.default_url_options ||= {}
    end

    # Generate a url based on the options provided, default_url_options and the
    # routes defined in routes.rb.  The following options are supported:
    #
    # * &lt;tt&gt;:only_path&lt;/tt&gt; - If true, the relative url is returned. Defaults to +false+.
    # * &lt;tt&gt;:protocol&lt;/tt&gt; - The protocol to connect to. Defaults to 'http'.
    # * &lt;tt&gt;:host&lt;/tt&gt; - Specifies the host the link should be targetted at.
    #   If &lt;tt&gt;:only_path&lt;/tt&gt; is false, this option must be
    #   provided either explicitly, or via +default_url_options+.
    # * &lt;tt&gt;:port&lt;/tt&gt; - Optionally specify the port to connect to.
    # * &lt;tt&gt;:anchor&lt;/tt&gt; - An anchor name to be appended to the path.
    # * &lt;tt&gt;:skip_relative_url_root&lt;/tt&gt; - If true, the url is not constructed using the
    #   +relative_url_root+ set in ActionController::Base.relative_url_root.
    # * &lt;tt&gt;:trailing_slash&lt;/tt&gt; - If true, adds a trailing slash, as in &quot;/archive/2009/&quot;
    #
    # Any other key (&lt;tt&gt;:controller&lt;/tt&gt;, &lt;tt&gt;:action&lt;/tt&gt;, etc.) given to
    # +url_for+ is forwarded to the Routes module.
    #
    # Examples:
    #
    #    url_for :controller =&gt; 'tasks', :action =&gt; 'testing', :host=&gt;'somehost.org', :port=&gt;'8080'    # =&gt; 'http://somehost.org:8080/tasks/testing'
    #    url_for :controller =&gt; 'tasks', :action =&gt; 'testing', :host=&gt;'somehost.org', :anchor =&gt; 'ok', :only_path =&gt; true    # =&gt; '/tasks/testing#ok'
    #    url_for :controller =&gt; 'tasks', :action =&gt; 'testing', :trailing_slash=&gt;true  # =&gt; 'http://somehost.org/tasks/testing/'
    #    url_for :controller =&gt; 'tasks', :action =&gt; 'testing', :host=&gt;'somehost.org', :number =&gt; '33'  # =&gt; 'http://somehost.org/tasks/testing?number=33'
    def url_for(options)
      options = self.class.default_url_options.merge(options)

      url = ''

      unless options.delete(:only_path)
        url &lt;&lt; (options.delete(:protocol) || 'http')
        url &lt;&lt; '://' unless url.match(&quot;://&quot;)

        raise &quot;Missing host to link to! Please provide :host parameter or set default_url_options[:host]&quot; unless options[:host]

        url &lt;&lt; options.delete(:host)
        url &lt;&lt; &quot;:#{options.delete(:port)}&quot; if options.key?(:port)
      else
        # Delete the unused options to prevent their appearance in the query string.
        [:protocol, :host, :port, :skip_relative_url_root].each { |k| options.delete(k) }
      end
      trailing_slash = options.delete(:trailing_slash) if options.key?(:trailing_slash)
      url &lt;&lt; ActionController::Base.relative_url_root.to_s unless options[:skip_relative_url_root]
      anchor = &quot;##{CGI.escape options.delete(:anchor).to_param.to_s}&quot; if options[:anchor]
      generated = Routing::Routes.generate(options, {})
      url &lt;&lt; (trailing_slash ? generated.sub(/\?|\z/) { &quot;/&quot; + $&amp; } : generated)
      url &lt;&lt; anchor if anchor

      url
    end
  end

  # Rewrites URLs for Base.redirect_to and Base.url_for in the controller.
  class UrlRewriter #:nodoc:
    RESERVED_OPTIONS = [:anchor, :params, :only_path, :host, :protocol, :port, :trailing_slash, :skip_relative_url_root]
    def initialize(request, parameters)
      @request, @parameters = request, parameters
    end

    def rewrite(options = {})
      rewrite_url(options)
    end

    def to_str
      &quot;#{@request.protocol}, #{@request.host_with_port}, #{@request.path}, #{@parameters[:controller]}, #{@parameters[:action]}, #{@request.parameters.inspect}&quot;
    end

    alias_method :to_s, :to_str

    private
      # Given a path and options, returns a rewritten URL string
      def rewrite_url(options)
        rewritten_url = &quot;&quot;

        unless options[:only_path]
          rewritten_url &lt;&lt; (options[:protocol] || @request.protocol)
          rewritten_url &lt;&lt; &quot;://&quot; unless rewritten_url.match(&quot;://&quot;)
          rewritten_url &lt;&lt; rewrite_authentication(options)
          rewritten_url &lt;&lt; (options[:host] || @request.host_with_port)
          rewritten_url &lt;&lt; &quot;:#{options.delete(:port)}&quot; if options.key?(:port)
        end

        path = rewrite_path(options)
        rewritten_url &lt;&lt; ActionController::Base.relative_url_root.to_s unless options[:skip_relative_url_root]
        rewritten_url &lt;&lt; (options[:trailing_slash] ? path.sub(/\?|\z/) { &quot;/&quot; + $&amp; } : path)
        rewritten_url &lt;&lt; &quot;##{options[:anchor]}&quot; if options[:anchor]

        rewritten_url
      end

      # Given a Hash of options, generates a route
      def rewrite_path(options)
        options = options.symbolize_keys
        options.update(options[:params].symbolize_keys) if options[:params]

        if (overwrite = options.delete(:overwrite_params))
          options.update(@parameters.symbolize_keys)
          options.update(overwrite.symbolize_keys)
        end

        RESERVED_OPTIONS.each { |k| options.delete(k) }

        # Generates the query string, too
        Routing::Routes.generate(options, @request.symbolized_path_parameters)
      end

      def rewrite_authentication(options)
        if options[:user] &amp;&amp; options[:password]
          &quot;#{CGI.escape(options.delete(:user))}:#{CGI.escape(options.delete(:password))}@&quot;
        else
          &quot;&quot;
        end
      end
  end
end
</pre>
    </div>